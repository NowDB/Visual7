<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title id="page-title"></title>
</head>

<body>
    <div id="container-parent">
        <div id="container"></div>
    </div>
</body>

<script>
    const prompt = require('electron-prompt');
    const pretty = require('pretty');
    const spawn = require('child_process').spawn;
    const path = require('path');
    const os = require('os');
    const fs = require('fs');

    var loadedThemes = null;
    var loadedThemesData = {};

    function loadTheme(theme) {
        var path = '../node_modules/monaco-themes/themes/' + theme + '.json';
        return fetch(path)
            .then(r => r.json())
            .then(data => {
                loadedThemesData[theme] = data;
                if (window.monaco) {
                    monaco.editor.defineTheme(theme, data);
                }
                return data;
            });
    }

    const amdLoader = require('../node_modules/monaco-editor/min/vs/loader.js');
    const amdRequire = amdLoader.require;
    const amdDefine = amdLoader.require.define;

    var parent_container_style = "position: absolute;top: 0;left: 0px;right: 0px;height: 100%;display: block; width: " + (window.screen.width * 80) / 100;
    var parent_container = document.getElementById("container-parent");
    parent_container.style.cssText = parent_container_style;

    var container_style = "height: 100%;position: relative;display: block;width: " + (window.screen.width * 80) / 100;
    var container = document.getElementById("container");
    container.style.cssText = container_style;

    window.onresize = function() {
        var parent_container_style = "position: absolute;top: 0;left: 0px;right: 0px;height: 100%;display: block; width: " + (window.screen.width * 80) / 100;
        var parent_container = document.getElementById("container-parent");
        parent_container.style.cssText = parent_container_style;

        var container_style = "height: 100%;position: relative;display: block;width: " + (window.screen.width * 80) / 100;
        var container = document.getElementById("container");
        container.style.cssText = container_style;
    };

    var file_open_active = null;

    (function() {
        self.module = undefined;

        var filename = null;
        var code_data = null;

        fs.readFile(path.join(__dirname, 'temp.html'), 'utf-8', (err, cb_data) => {
            if (err) {
                console.log(err);
                return;
            }

            filename = cb_data;
            file_open_active = cb_data;
            document.getElementById('page-title').innerHTML = filename;

            fs.readFile(path.join(__dirname, 'pages/' + filename), 'utf-8', (err, cb_data) => {
                if (err) {
                    console.log(err);
                    return;
                }

                code_data = cb_data;

                function uriFromPath(_path) {
                    var pathName = path.resolve(_path).replace(/\\/g, '/');
                    if (pathName.length > 0 && pathName.charAt(0) !== '/') {
                        pathName = '/' + pathName;
                    }
                    return encodeURI('file://' + pathName);
                }

                amdRequire.config({
                    baseUrl: uriFromPath(path.join(__dirname, '../node_modules/monaco-editor/min'))
                });

                amdRequire(['vs/editor/editor.main'], function() {
                    loadTheme('Monokai').then(function(callback) {
                        monaco.editor.defineTheme(callback.base, {
                            base: callback.base,
                            inherit: true,
                            rules: [callback.rules],
                            colors: callback.colors
                        });
                        monaco.editor.setTheme(callback.base);

                        window.editor = monaco.editor.create(document.getElementById('container'), {
                            value: [code_data].join('\n'),
                            language: 'html'
                        });
                    });
                });
            });
        });
    })();

    document.addEventListener('keydown', function(event) {
        if (event.code == 'KeyS' && (event.ctrlKey || event.metaKey)) {
            var editor_html = window.editor.getValue();
            fs.writeFileSync(path.join(__dirname, 'pages/' + file_open_active), editor_html, 'utf-8');
            alert('Saved');
        }
    });
</script>

</html>